# Development Dockerfile
FROM node:24-alpine

# Install build dependencies
RUN apk add --no-cache \
  python3 \
  make \
  g++ \
  bash \
  sqlite

# Enable Corepack and pre-activate pnpm
ENV PNPM_HOME="/pnpm"
ENV PATH="$PNPM_HOME:$PATH"
RUN corepack enable && \
  corepack prepare pnpm@10.22.0 --activate

WORKDIR /app

# Copy pnpm-workspace.yaml to allow building sqlite3
COPY pnpm-workspace.yaml ./

# Copy only lockfile first for better caching
COPY pnpm-lock.yaml ./

# Fetch packages using BuildKit cache mount
RUN --mount=type=cache,id=pnpm-dev,target=/pnpm/store \
  pnpm fetch

# Copy package files and tsconfig
COPY package.json tsconfig*.json ./

# Install all dependencies
RUN --mount=type=cache,id=pnpm-dev,target=/pnpm/store \
  pnpm install --offline --frozen-lockfile

# Copy source code (this layer invalidates frequently)
COPY . .

# Expose ports for dev server and debugging
EXPOSE 3000 9229

# Development environment variables
ENV NODE_ENV=development \
  CHOKIDAR_USEPOLLING=1 \
  NODE_OPTIONS="--max-old-space-size=512"

# Run the dev server with hot reload
CMD ["pnpm", "run", "dev"]
